<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WordApp</title>
  <style>
    :root { --w: 900px; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding: 22px; background:#fff; color:#111; }
    h1 { margin: 0 0 16px; font-size: 44px; font-weight: 800; }
    .wrap { max-width: var(--w); margin: 0 auto; }
    input, textarea, button {
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
      padding: 14px 16px;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      outline: none;
      background: #fff;
    }
    textarea { min-height: 110px; resize: vertical; }
    input:focus, textarea:focus { border-color:#cfcfcf; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
    .btn { background:#efefef; border:1px solid #e1e1e1; font-weight: 700; cursor:pointer; }
    .btn:active { transform: scale(0.99); }
    .btn.primary { background:#e9e9e9; }
    .btn.danger { background:#efefef; }
    .card {
      margin-top: 16px;
      border: 1px solid #e9e9e9;
      border-radius: 12px;
      padding: 18px;
      min-height: 90px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size: 30px;
      font-weight: 800;
      background:#fff;
    }
    .meta { margin-top: 10px; font-size: 16px; color:#333; }
    .ok { color:#0a7a2a; font-weight:700; }
    .bad { color:#b00020; font-weight:700; }
    hr { border:none; border-top:1px solid #eee; margin: 18px 0; }

    /* Quiz */
    .quizBox { margin-top: 10px; border: 1px solid #e9e9e9; border-radius: 12px; padding: 14px; }
    .quizQ { font-size: 24px; font-weight: 800; margin: 6px 0 10px; text-align:center; }
    .quizChoices { display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
    .choice { background:#f3f3f3; border:1px solid #e2e2e2; font-weight:700; text-align:left; }
    .choice.correct { background:#e7f7ea; border-color:#bfe6c7; }
    .choice.wrong { background:#fde7ea; border-color:#f3b8c1; }
    .quizMeta { margin-top: 10px; display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; font-size: 15px; color:#333; }
    .small { font-size: 14px; color:#666; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#f3f3f3; font-size: 12px; }
    @media (max-width: 720px){
      h1 { font-size: 40px; }
      .grid2 { grid-template-columns: 1fr; }
      .card { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WordApp</h1>

    <input id="en" type="text" placeholder="English" autocomplete="off" />
    <div style="height:12px"></div>
    <input id="tr" type="text" placeholder="T√ºrk√ße" autocomplete="off" />

    <div class="grid2">
      <button class="btn primary" onclick="addWord()">Kelime Ekle</button>
      <button class="btn primary" onclick="randomWord()">Kelime √áalƒ±≈ü (Rastgele)</button>
      <button class="btn" onclick="showAnswer()">Cevabƒ± G√∂ster</button>
      <button class="btn danger" onclick="deleteCurrent()">Bu Kelimeyi Sil</button>
    </div>

    <div class="card" id="card">Hen√ºz soru yok</div>

    <div class="meta">
      <div>Toplam kelime: <b id="count">0</b></div>
      <div id="status" class="ok">‚úÖ Hazƒ±r. Kelime ekleyebilirsin.</div>
    </div>

    <hr/>

    <div class="grid2">
      <button class="btn" onclick="makeBackup()">Yedek Al (JSON)</button>
      <button class="btn" onclick="copyBackup()">JSON Kopyala</button>
      <button class="btn" onclick="importBackup()">JSON ƒ∞√ße Aktar</button>
    </div>

    <div style="height:12px"></div>
    <textarea id="backupArea" placeholder="Yedek JSON burada g√∂r√ºnecek / buraya yapƒ±≈ütƒ±rƒ±p ƒ∞√ße Aktar'a basabilirsin"></textarea>

    <div class="small" style="margin-top:10px; line-height:1.5;">
      ‚Ä¢ Kelimeler cihazƒ±nda kalƒ±cƒ± kaydedilir (localStorage).<br/>
      ‚Ä¢ Yedek almak i√ßin ‚ÄúYedek Al (JSON)‚Äù ‚Üí JSON‚Äôu kopyalayƒ±p Notlar‚Äôa/Drive‚Äôa kaydedebilirsin.<br/>
      ‚Ä¢ Geri y√ºklemek i√ßin JSON‚Äôu buraya yapƒ±≈ütƒ±r ‚Üí ‚ÄúJSON ƒ∞√ße Aktar‚Äù.
    </div>

    <hr/>

    <!-- QUIZ MOD√úL√ú -->
    <h2 style="margin: 0 0 10px; font-size:26px;">√áoktan Se√ßmeli Quiz (EN ‚Üí TR)</h2>

    <div class="grid2">
      <button class="btn primary" onclick="quizStart()">Quiz Ba≈ülat</button>
      <button class="btn" onclick="quizNext()">Sonraki Soru</button>
    </div>

    <div class="quizBox">
      <div class="quizQ" id="quizQuestion">Quiz hen√ºz ba≈ülamadƒ±</div>
      <div class="quizChoices" id="quizChoices"></div>

      <div class="quizMeta">
        <span class="pill">Skor: <b id="quizScore">0</b> / <b id="quizTotal">0</b></span>
        <span class="pill">Bug√ºn: <b id="dailyDone">0</b> / <b id="dailyGoal">30</b></span>
        <span class="pill">Tekrar kuyruƒüu: <b id="retryCount">0</b></span>
      </div>

      <div id="quizStatus" class="small" style="margin-top:10px;">
        En az 4 kelime ekleyince quiz daha iyi √ßalƒ±≈üƒ±r.
      </div>
    </div>

  </div>

<script>
  // ---------- STORAGE ----------
  const STORAGE_KEY = "wordapp_words_v1";

  // Quiz extra state keys
  const QUIZ_DAILY_KEY = "wordapp_quiz_daily_v1";
  const QUIZ_RETRY_KEY = "wordapp_quiz_retry_v1";

  const DAILY_GOAL = 30;                 // <-- senin se√ßimin
  const AUTO_NEXT_DELAY_MS = 700;        // doƒüru cevap sonrasƒ± otomatik ge√ßi≈ü

  let words = [];
  let current = null;       // {en,tr}
  let showingAnswer = false;

  // ---------- QUIZ STATE ----------
  let quizActive = false;
  let quizCurrent = null;   // { word, options[], correctIndex }
  let quizAnswered = false;

  let quizScore = 0;
  let quizTotal = 0;

  // Daily progress
  let dailyDate = "";
  let dailyDone = 0;

  // Retry queue (wrong answers asked again)
  // stored as array of strings keys "en|||tr"
  let retryQueue = [];
  let autoNextTimer = null;

  function todayKey() {
    // YYYY-MM-DD in local time
    const d = new Date();
    const y = String(d.getFullYear());
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function load() {
    // load words
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      words = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(words)) words = [];
    } catch {
      words = [];
    }

    // load daily
    loadDaily();

    // load retry queue
    loadRetryQueue();

    updateCount();
    updateInfo("‚úÖ Hazƒ±r. Kelime ekleyebilirsin.", true);
    renderDailyUI();
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(words));
    updateCount();
  }

  function updateCount() {
    document.getElementById("count").innerText = String(words.length);
  }

  function updateInfo(msg, ok=true) {
    const el = document.getElementById("status");
    el.className = ok ? "ok" : "bad";
    el.innerText = msg;
  }

  function normalize(s) {
    return (s || "").trim();
  }

  function keyOfWord(w) {
    return `${w.en}|||${w.tr}`;
  }

  // ---------- DAILY ----------
  function loadDaily() {
    const t = todayKey();
    try {
      const raw = localStorage.getItem(QUIZ_DAILY_KEY);
      if (!raw) {
        dailyDate = t;
        dailyDone = 0;
        persistDaily();
        return;
      }
      const obj = JSON.parse(raw);
      const savedDate = typeof obj.date === "string" ? obj.date : "";
      const savedDone = typeof obj.done === "number" ? obj.done : 0;

      if (savedDate !== t) {
        // new day
        dailyDate = t;
        dailyDone = 0;
        persistDaily();
      } else {
        dailyDate = savedDate;
        dailyDone = savedDone;
      }
    } catch {
      dailyDate = t;
      dailyDone = 0;
      persistDaily();
    }
  }

  function persistDaily() {
    localStorage.setItem(QUIZ_DAILY_KEY, JSON.stringify({ date: dailyDate, done: dailyDone }));
  }

  function incDaily() {
    loadDaily(); // ensure date rollover
    dailyDone += 1;
    persistDaily();
    renderDailyUI();
  }

  function renderDailyUI() {
    document.getElementById("dailyGoal").innerText = String(DAILY_GOAL);
    document.getElementById("dailyDone").innerText = String(dailyDone);
  }

  // ---------- RETRY QUEUE ----------
  function loadRetryQueue() {
    try {
      const raw = localStorage.getItem(QUIZ_RETRY_KEY);
      retryQueue = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(retryQueue)) retryQueue = [];
    } catch {
      retryQueue = [];
    }
    renderRetryUI();
  }

  function persistRetryQueue() {
    localStorage.setItem(QUIZ_RETRY_KEY, JSON.stringify(retryQueue));
    renderRetryUI();
  }

  function renderRetryUI() {
    document.getElementById("retryCount").innerText = String(retryQueue.length);
  }

  function enqueueRetry(word) {
    const k = keyOfWord(word);
    // add twice to increase probability (asked again sooner)
    retryQueue.push(k);
    retryQueue.push(k);
    // keep queue reasonable
    if (retryQueue.length > 80) retryQueue = retryQueue.slice(retryQueue.length - 80);
    persistRetryQueue();
  }

  function dequeueRetryWordOrNull() {
    if (retryQueue.length === 0) return null;
    const k = retryQueue.shift();
    persistRetryQueue();
    const [en, tr] = k.split("|||");
    const found = words.find(w => w.en === en && w.tr === tr);
    return found || null;
  }

  // ---------- MAIN FEATURES ----------
  function addWord() {
    const en = normalize(document.getElementById("en").value);
    const tr = normalize(document.getElementById("tr").value);

    if (!en || !tr) {
      updateInfo("‚ùå ƒ∞ngilizce ve T√ºrk√ße alanlarƒ±nƒ± doldur.", false);
      return;
    }

    // duplicates: same EN+TR
    const exists = words.some(w => (w.en || "").toLowerCase() === en.toLowerCase() && (w.tr || "").toLowerCase() === tr.toLowerCase());
    if (exists) {
      updateInfo("‚ö†Ô∏è Bu kelime zaten ekli.", false);
      return;
    }

    words.push({ en, tr });
    save();

    document.getElementById("en").value = "";
    document.getElementById("tr").value = "";
    updateInfo("‚úÖ Kelime eklendi.", true);
  }

  function randomWord() {
    if (words.length === 0) {
      updateInfo("‚ùå Hen√ºz kelime yok. √ñnce kelime ekle.", false);
      document.getElementById("card").innerText = "Hen√ºz soru yok";
      current = null;
      return;
    }
    const idx = Math.floor(Math.random() * words.length);
    current = words[idx];
    showingAnswer = false;
    document.getElementById("card").innerText = current.en;
    updateInfo("‚úÖ Soru geldi. ƒ∞stersen cevabƒ± g√∂ster.", true);
  }

  function showAnswer() {
    if (!current) {
      updateInfo("‚ùå √ñnce ‚ÄúKelime √áalƒ±≈ü (Rastgele)‚Äù ile soru getir.", false);
      return;
    }
    document.getElementById("card").innerText = current.tr;
    showingAnswer = true;
    updateInfo("‚úÖ Cevap g√∂sterildi.", true);
  }

  function deleteCurrent() {
    if (!current) {
      updateInfo("‚ùå Silmek i√ßin √∂nce bir kelime getir.", false);
      return;
    }
    const before = words.length;
    words = words.filter(w => !(w.en === current.en && w.tr === current.tr));
    const after = words.length;
    save();

    // also remove from retryQueue
    const k = keyOfWord(current);
    if (retryQueue.length) {
      retryQueue = retryQueue.filter(x => x !== k);
      persistRetryQueue();
    }

    current = null;
    showingAnswer = false;
    document.getElementById("card").innerText = "Hen√ºz soru yok";
    updateInfo(after < before ? "‚úÖ Kelime silindi." : "‚ö†Ô∏è Kelime bulunamadƒ±.", after < before);
  }

  // ---------- BACKUP ----------
  function makeBackup() {
    document.getElementById("backupArea").value = JSON.stringify(words, null, 2);
    updateInfo("‚úÖ JSON yedek hazƒ±r. ƒ∞stersen kopyalayabilirsin.", true);
  }

  async function copyBackup() {
    const txt = document.getElementById("backupArea").value.trim();
    if (!txt) {
      updateInfo("‚ùå √ñnce ‚ÄúYedek Al (JSON)‚Äù ile JSON olu≈ütur.", false);
      return;
    }
    try {
      await navigator.clipboard.writeText(txt);
      updateInfo("‚úÖ JSON kopyalandƒ±.", true);
    } catch {
      const ta = document.getElementById("backupArea");
      ta.focus();
      ta.select();
      updateInfo("‚ö†Ô∏è Otomatik kopyalanamadƒ±. Se√ßildi‚ÄîKopyala yap.", false);
    }
  }

  function importBackup() {
    const txt = document.getElementById("backupArea").value.trim();
    if (!txt) {
      updateInfo("‚ùå JSON alanƒ± bo≈ü.", false);
      return;
    }
    try {
      const arr = JSON.parse(txt);
      if (!Array.isArray(arr)) throw new Error("not array");
      const cleaned = arr
        .filter(x => x && typeof x.en === "string" && typeof x.tr === "string")
        .map(x => ({ en: normalize(x.en), tr: normalize(x.tr) }))
        .filter(x => x.en && x.tr);

      words = cleaned;
      save();
      updateInfo("‚úÖ JSON i√ße aktarƒ±ldƒ±.", true);

      // retry queue may contain old keys; clean it
      retryQueue = retryQueue.filter(k => {
        const [en,tr] = k.split("|||");
        return words.some(w => w.en === en && w.tr === tr);
      });
      persistRetryQueue();

    } catch {
      updateInfo("‚ùå JSON ge√ßersiz. Formatƒ± kontrol et.", false);
    }
  }

  // ---------- QUIZ ----------
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function quizStart() {
    clearAutoNext();

    if (words.length < 4) {
      document.getElementById("quizStatus").innerText = "‚ùå Quiz i√ßin en az 4 kelime lazƒ±m (4 ≈üƒ±k √ºretiyoruz).";
      return;
    }
    quizActive = true;
    quizScore = 0;
    quizTotal = 0;
    quizAnswered = false;
    quizCurrent = null;

    // ensure daily loaded/reset if day changed
    loadDaily();
    renderDailyUI();

    document.getElementById("quizScore").innerText = "0";
    document.getElementById("quizTotal").innerText = "0";
    document.getElementById("quizStatus").innerText = "‚úÖ Quiz ba≈üladƒ±. ≈ûƒ±klardan birini se√ß.";
    quizNext();
  }

  function quizNext() {
    clearAutoNext();

    if (!quizActive) {
      document.getElementById("quizStatus").innerText = "√ñnce ‚ÄúQuiz Ba≈ülat‚Äùa bas.";
      return;
    }
    if (words.length < 4) {
      document.getElementById("quizStatus").innerText = "‚ùå Quiz i√ßin en az 4 kelime lazƒ±m.";
      return;
    }

    // daily rollover check
    loadDaily();
    renderDailyUI();

    // If daily goal reached, still allow continue but show message
    const reached = dailyDone >= DAILY_GOAL;

    quizAnswered = false;

    // 60% chance: ask from retry queue if available, else random.
    let correct = null;
    if (retryQueue.length > 0 && Math.random() < 0.6) {
      correct = dequeueRetryWordOrNull();
    }
    if (!correct) {
      correct = words[Math.floor(Math.random() * words.length)];
    }

    // pick wrong options from other words (unique TR)
    const wrongPool = words.filter(w => !(w.en === correct.en && w.tr === correct.tr));
    shuffle(wrongPool);

    const options = [correct.tr];
    for (let i = 0; i < wrongPool.length && options.length < 4; i++) {
      const tr = wrongPool[i].tr;
      if (!options.includes(tr)) options.push(tr);
    }

    // fallback if collisions
    if (options.length < 4) {
      const allTr = [...new Set(words.map(w => w.tr))].filter(tr => tr !== correct.tr);
      shuffle(allTr);
      for (const tr of allTr) {
        if (options.length >= 4) break;
        if (!options.includes(tr)) options.push(tr);
      }
    }

    if (options.length < 4) {
      document.getElementById("quizStatus").innerText =
        "‚ö†Ô∏è T√ºrk√ße kar≈üƒ±lƒ±klar √ßok tekrar ediyor. Daha fazla kelime ekleyince 4 ≈üƒ±k daha saƒülam olur.";
    } else {
      document.getElementById("quizStatus").innerText =
        reached ? "üéâ G√ºnl√ºk hedef tamamlandƒ±! ƒ∞stersen devam edebilirsin." : "≈ûƒ±klardan birini se√ß.";
    }

    shuffle(options);
    const correctIndex = options.indexOf(correct.tr);

    quizCurrent = { word: correct, options, correctIndex };

    document.getElementById("quizQuestion").innerText = `‚Äú${correct.en}‚Äù ne demek?`;
    renderChoices();
  }

  function renderChoices() {
    const box = document.getElementById("quizChoices");
    box.innerHTML = "";

    quizCurrent.options.forEach((opt, idx) => {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.innerText = opt;
      btn.onclick = () => quizAnswer(idx, btn);
      box.appendChild(btn);
    });
  }

  function clearAutoNext() {
    if (autoNextTimer) {
      clearTimeout(autoNextTimer);
      autoNextTimer = null;
    }
  }

  function quizAnswer(idx, btnEl) {
    if (!quizActive || !quizCurrent || quizAnswered) return;
    quizAnswered = true;

    quizTotal += 1;
    document.getElementById("quizTotal").innerText = String(quizTotal);

    // daily progress increments on every answered question
    incDaily();

    const buttons = [...document.querySelectorAll("#quizChoices .choice")];
    const correctIdx = quizCurrent.correctIndex;

    buttons.forEach((b, i) => {
      b.disabled = true;
      if (i === correctIdx) b.classList.add("correct");
    });

    if (idx === correctIdx) {
      quizScore += 1;
      document.getElementById("quizScore").innerText = String(quizScore);

      // daily status message
      if (dailyDone >= DAILY_GOAL) {
        document.getElementById("quizStatus").innerText = `‚úÖ Doƒüru! üéâ Bug√ºn ${dailyDone}/${DAILY_GOAL} hedef tamamlandƒ±!`;
      } else {
        document.getElementById("quizStatus").innerText = `‚úÖ Doƒüru! (${dailyDone}/${DAILY_GOAL}) Otomatik sonraki soru...`;
      }

      // auto-next
      autoNextTimer = setTimeout(() => {
        quizNext();
      }, AUTO_NEXT_DELAY_MS);

    } else {
      btnEl.classList.add("wrong");

      // enqueue wrong word to retry queue
      enqueueRetry(quizCurrent.word);

      document.getElementById("quizStatus").innerText =
        `‚ùå Yanlƒ±≈ü. Doƒüru: ‚Äú${quizCurrent.options[correctIdx]}‚Äù. (${dailyDone}/${DAILY_GOAL}) Tekrar sorulacak.`;

      // no auto-next on wrong (kullanƒ±cƒ± g√∂rs√ºn). ƒ∞stersen bunu da otomatik yaparƒ±z.
    }

    // refresh retry counter
    renderRetryUI();
  }

  // init
  load();

  // expose functions
  window.addWord = addWord;
  window.randomWord = randomWord;
  window.showAnswer = showAnswer;
  window.deleteCurrent = deleteCurrent;

  window.makeBackup = makeBackup;
  window.copyBackup = copyBackup;
  window.importBackup = importBackup;

  window.quizStart = quizStart;
  window.quizNext = quizNext;
</script>
</body>
</html>
